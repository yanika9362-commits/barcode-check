<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barcode Format QC</title>

<script src="https://docs.opencv.org/4.x/opencv.js"></script>

<style>
body {
  margin:0;
  background:black;
  overflow:hidden;
  font-family:Arial, sans-serif;
}

video, canvas {
  position:absolute;
  top:0; left:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
}

#a4 {
  position:absolute;
  width:70vw;
  height:99vw;       /* ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô A4 */
  border:4px dashed yellow;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
}

#status {
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  font-size:28px;
  padding:10px 20px;
  border-radius:10px;
  background:rgba(0,0,0,0.7);
  color:white;
}

.pass { color:#00ff00; }
.fail { color:#ff3333; }

button {
  font-size:18px;
  padding:8px 16px;
  border:none;
  border-radius:10px;
}

#btnMaster {
  position:absolute;
  top:20px;
  left:50%;
  transform:translateX(-50%);
}

#btnSwitch {
  position:absolute;
  top:70px;
  left:50%;
  transform:translateX(-50%);
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<div id="a4"></div>

<button id="btnMaster">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢ MASTER</button>
<button id="btnSwitch">üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>

<div id="status">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ MASTER</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusBox = document.getElementById("status");
const btnMaster = document.getElementById("btnMaster");
const btnSwitch = document.getElementById("btnSwitch");

// ----------------- ‡∏Å‡∏•‡πâ‡∏≠‡∏á -----------------
let currentFacing = "environment";
let currentStream = null;

function startCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(t => t.stop());
  }

  navigator.mediaDevices.getUserMedia({
    video: { facingMode: currentFacing },
    audio: false
  }).then(stream => {
    currentStream = stream;
    video.srcObject = stream;
  }).catch(() => {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
  });
}

startCamera();

btnSwitch.onclick = () => {
  currentFacing = currentFacing === "environment" ? "user" : "environment";
  startCamera();
};

// ----------------- Master -----------------
let master = JSON.parse(localStorage.getItem("MASTER_DATA"));

btnMaster.onclick = () => {
  captureMaster();
};

function captureMaster() {
  drawFrame();

  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

  let thresh = new cv.Mat();
  cv.threshold(gray, thresh, 0, 255,
    cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

  let inkPixels = cv.countNonZero(thresh);
  let inkRatio = inkPixels / (thresh.rows * thresh.cols);

  master = {
    inkRatio: inkRatio
  };

  localStorage.setItem("MASTER_DATA", JSON.stringify(master));

  statusBox.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å MASTER ‡πÅ‡∏•‡πâ‡∏ß";
  statusBox.className = "pass";

  src.delete(); gray.delete(); thresh.delete();
}

// ----------------- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå -----------------
function drawFrame() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
}

function analyze() {
  if (!master || video.videoWidth === 0) return;

  drawFrame();

  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

  let thresh = new cv.Mat();
  cv.threshold(gray, thresh, 0, 255,
    cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

  let inkPixels = cv.countNonZero(thresh);
  let inkRatio = inkPixels / (thresh.rows * thresh.cols);

  if (inkRatio < master.inkRatio * 0.9) {
    statusBox.textContent = "‚ùå FAIL : ‡∏´‡∏°‡∏∂‡∏Å‡∏à‡∏≤‡∏á / ‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏≤‡∏¢";
    statusBox.className = "fail";
  } else {
    statusBox.textContent = "‚úÖ PASS";
    statusBox.className = "pass";
  }

  src.delete(); gray.delete(); thresh.delete();
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(analyze, 500);
</script>

</body>
</html>
